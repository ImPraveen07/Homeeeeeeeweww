<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sleek Gallery - Pro Ultra V2 Fixed</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; touch-action: none; font-family: sans-serif; user-select: none; }
        #loader-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .loader-ring { width: 60px; height: 60px; border: 3px solid #222; border-top: 3px solid #007bff; border-radius: 50%; animation: spin 1s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .loader-text { color: #fff; font-size: 10px; margin-top: 20px; letter-spacing: 2px; text-transform: uppercase; font-weight: bold; }
        #loader-stats { color: #007bff; font-size: 11px; margin-top: 8px; font-family: monospace; }
        .progress-container { width: 180px; height: 2px; background: #222; margin-top: 15px; border-radius: 2px; overflow: hidden; }
        #progress-bar { width: 0%; height: 100%; background: #007bff; transition: width 0.3s; }
        #ui-layer, #pro-editor, #model-list, .action-btn { z-index: 1000; position: absolute; }
        #ui-layer { top: 15px; width: 100%; text-align: center; pointer-events: none; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        #room-display { font-size: 10px; color: #fff; background: rgba(0,0,0,0.7); padding: 4px 12px; border-radius: 4px; letter-spacing: 1px; }
        #copy-btn { pointer-events: auto; background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 11px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        #pro-editor { left: 8px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.85); color: white; padding: 10px; border-radius: 10px; display: flex; flex-direction: column; gap: 2px; pointer-events: auto; font-size: 9px; width: 175px; max-height: 85vh; overflow-y: auto; border: 1px solid #444; }
        .ctrl-row { display: flex; align-items: center; justify-content: space-between; margin-top: 4px; }
        .val-grp { display: flex; align-items: center; gap: 2px; }
        .num-in { width: 40px; background: #111; border: 1px solid #444; color: #007bff; text-align: center; font-size: 9px; padding: 2px 0; }
        .step-b { background: #444; color: #fff; border: none; width: 20px; height: 20px; cursor: pointer; font-weight: bold; }
        #pro-editor input[type="range"] { width: 100%; margin: 2px 0 6px 0; height: 3px; accent-color: #007bff; }
        .snap-row { display: flex; justify-content: space-between; margin-bottom: 4px; gap: 2px; }
        .snap-dot { background: #333; color: #fff; border: 1px solid #555; font-size: 8px; padding: 2px 0; flex: 1; text-align: center; cursor: pointer; }
        #model-list { right: 10px; top: 15px; width: 150px; background: rgba(0,0,0,0.7); color: white; padding: 8px; border-radius: 6px; font-size: 9px; pointer-events: auto; max-height: 40vh; overflow-y: auto; border: 1px solid #444; }
        .list-item { background: #333; padding: 6px; margin-top: 4px; border-radius: 3px; border-left: 3px solid #007bff; }
        .row { display: flex; justify-content: space-between; gap: 4px; margin-top: 4px; }
        .ui-s-btn { color:white; background:#007bff; border:none; padding: 4px; border-radius: 2px; cursor: pointer; font-size: 8px; flex: 1; text-align: center; }
        .ui-s-btn.dup { background: #6f42c1; }
        .ui-s-btn.del { background: #dc3545; }
        .action-btn { left: 50%; transform: translateX(-50%); padding: 12px 24px; font-size: 13px; font-weight: bold; color: #fff; border-radius: 30px; display: none; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        #door-btn { top: 35%; background: #444; }
        #power-btn { bottom: 85px; background: #222; transition: background 0.3s; }
        #interact-btn { bottom: 30px; background: #007bff; }
        #zone-move, #zone-look { position: absolute; top: 0; width: 48vw; height: 100vh; z-index: 500; }
        #zone-move { left: 0; } #zone-look { right: 0; }
        #joy-container { position: absolute; width: 70px; height: 70px; display: none; pointer-events: none; z-index: 600; transform: translate(-50%, -50%); }
        #joy-base { width: 100%; height: 100%; border: 2px solid rgba(255,255,255,0.2); border-radius: 50%; background: rgba(255,255,255,0.1); }
        #joy-stick { position: absolute; top: 50%; left: 50%; width: 25px; height: 25px; background: #fff; border-radius: 50%; transform: translate(-50%, -50%); }
        #crosshair { position: fixed; top: 50%; left: 50%; width: 4px; height: 4px; background: rgba(255,255,255,0.6); border-radius: 50%; transform: translate(-50%, -50%); z-index: 2000; pointer-events: none; }
        #html-frame-element { width: 1280px; height: 720px; background: #000; border: 15px solid #111; box-sizing: border-box; }
        #totify-iframe { width: 100%; height: 100%; border: none; }
        #touch-blocker { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: transparent; z-index: 99; }
        .model-label { color: #fff; background: rgba(0,0,0,0.8); padding: 3px 8px; border-radius: 4px; font-size: 9px; white-space: nowrap; pointer-events: none; border: 1px solid #555; }
    </style>
</head>
<body>

<div id="loader-screen">
    <div class="loader-ring"></div>
    <div class="loader-text" id="loader-msg">Initializing Storage</div>
    <div id="loader-stats">0.0 MB / CALCULATING...</div>
    <div class="progress-container"><div id="progress-bar"></div></div>
</div>

<div id="crosshair"></div>
<div id="ui-layer">
    <div id="room-display">SPAWN ROOM</div>
    <button id="copy-btn">ðŸ“‹ COPY SCENE INFO</button>
</div>
<div id="model-list"><strong>USER ITEMS</strong><div id="items-container"></div></div>
<div id="pro-editor">
    <strong style="color:#007bff">PRO TOOLS</strong>
    <input type="file" id="file-input" accept=".glb,.gltf,.jpg,.png,.jpeg,.webp">
    <div id="dynamic-controls"></div>
    <button style="background:#28a745; color:white; border:none; padding:6px; margin-top:5px; font-size:10px; cursor:pointer;" onclick="window.editingIndex = -1">DONE / LOCK</button>
</div>

<button id="door-btn" class="action-btn">ðŸšª OPEN DOOR</button>
<button id="power-btn" class="action-btn">ðŸ”Œ POWER ON</button>
<button id="interact-btn" class="action-btn">ðŸŽ¯ INTERACT</button>

<div id="zone-move"></div><div id="zone-look"></div>
<div id="joy-container"><div id="joy-base"></div><div id="joy-stick"></div></div>

<div style="display:none;"><div id="html-frame-element"><div id="touch-blocker"></div><iframe id="totify-iframe"></iframe></div></div>

<script type="importmap">{ "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/" } }</script>
<script type="module">
    import * as THREE from 'three';
    import { CSS3DRenderer, CSS3DObject } from 'three/addons/renderers/CSS3DRenderer.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';

    // --- MEMORY UTILS ---
    const disposeObj = (obj) => {
        obj.traverse(node => {
            if (node.isMesh) {
                if (node.geometry) node.geometry.dispose();
                if (node.material) {
                    if (Array.isArray(node.material)) node.material.forEach(m => m.dispose());
                    else node.material.dispose();
                }
            }
        });
    };

    const DB_NAME = "GalleryCache_72", STORE_NAME = "models";
    let db = null;
    const initDB = () => new Promise((res) => {
        const req = indexedDB.open(DB_NAME, 2);
        req.onupgradeneeded = e => {
            let database = e.target.result;
            if (!database.objectStoreNames.contains(STORE_NAME)) database.createObjectStore(STORE_NAME);
        };
        req.onsuccess = e => { db = e.target.result; res(); };
        req.onerror = () => res();
    });
    const getCached = (key) => new Promise(res => {
        if (!db) return res(null);
        const tx = db.transaction(STORE_NAME, "readonly");
        const req = tx.objectStore(STORE_NAME).get(key);
        req.onsuccess = () => res(req.result);
        req.onerror = () => res(null);
    });
    const saveCached = (key, blob) => new Promise(res => {
        if (!db) return res();
        const tx = db.transaction(STORE_NAME, "readwrite");
        tx.objectStore(STORE_NAME).put(blob, key);
        tx.oncomplete = () => res();
    });

    const floorY = -50, T = 350, W = 1200, H = 1200;
    let isDoorOpen = false, isPowered = false, isInteracting = false;
    let velocity = new THREE.Vector3(), move = {x:0, y:0}, savedModels = [], mixers = [];
    window.editingIndex = -1;
    const clock = new THREE.Clock();
    const scene = new THREE.Scene(); 
    const cssScene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 1, 7000);
    camera.rotation.order = 'YXZ';

    const cssRenderer = new CSS3DRenderer();
    cssRenderer.setSize(window.innerWidth, window.innerHeight);
    cssRenderer.domElement.style.position = 'absolute';
    cssRenderer.domElement.style.top = '0';
    cssRenderer.domElement.style.zIndex = '1';
    cssRenderer.domElement.style.pointerEvents = 'none'; 
    document.body.appendChild(cssRenderer.domElement);

    const renderer = new THREE.WebGLRenderer({ 
        antialias: true, 
        alpha: true,
        powerPreference: "high-performance",
        precision: "mediump" 
    });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = .5;

    renderer.setClearColor(0x111111, 1); 
    renderer.domElement.style.position = 'absolute';
    renderer.domElement.style.top = '0';
    renderer.domElement.style.zIndex = '2'; 
    document.body.appendChild(renderer.domElement);

    const pmremGenerator = new THREE.PMREMGenerator(renderer);
    scene.environment = pmremGenerator.fromScene(new RoomEnvironment(), 0.04).texture;

    scene.add(new THREE.AmbientLight(0xffffff, 1.2));
    const dirLight = new THREE.DirectionalLight(0xffffff, 2.5);
    dirLight.position.set(0, 300, 0); 
    scene.add(dirLight);

    const texLoader = new THREE.TextureLoader();
    const loader = new GLTFLoader();
    const sharedPlaneGeom = new THREE.PlaneGeometry(1, 1);

    const textureCache = {};
    const getTex = (url) => {
        if (!textureCache[url]) textureCache[url] = texLoader.load(url);
        return textureCache[url];
    };

    const glbItems = [
        { src: 'rocco_on_his_couch.glb', p: [494, 8, 284], r: [0, 270], s: [136, 136, 136] },
        { src: 'end_table_-_wooden_with_magazine_rack.glb', p: [522, -39, 510], r: [0, 180], s: [98, 98, 98] },
        { src: 'ventilador.glb', p: [16, 189, 320], r: [0, 0], s: [85, 85, 85] },
        { src: 'light_switch (1).glb', p: [-70, -26, 9], r: [180, 180], s: [155, 155, 155] },
        { src: 'light_switch (1).glb', p: [73, -26, -9], r: [0, 0], s: [155, 155, 155] },
        { src: '2533ef500ece4fcc804872c706df036b (1).glb', p: [-7, 177, 7], r: [0, 0], s: [41, 41, 41] },
        { src: 'stage.glb', p: [-294, 97, -564], r: [0, 90], s: [173, 173, 173] },
        { src: 'stage.glb', p: [-553, 97, -564], r: [0, 90], s: [173, 173, 173] },
        { src: 'stage.glb', p: [236, 97, -564], r: [0, 90], s: [173, 173, 173] },
        { src: 'stage.glb', p: [-30, 97, -564], r: [0, 90], s: [173, 173, 173] },
        { src: 'stage.glb', p: [493, 97, -564], r: [0, 90], s: [173, 173, 173] },
        { src: 'tablecloth_lowpoly.glb', p: [5, -35, -380], r: [0, 0], s: [90, 90, 90] },
        { src: 'textured.glb', p: [1, 27, -385], r: [0, 0], s: [14, 14, 14] },
        { src: 'tablecloth_lowpoly.glb', p: [-69, -35, -265], r: [0, 90], s: [90, 90, 90] },
        { src: 'tablecloth_lowpoly.glb', p: [79, -35, -265], r: [0, 90], s: [90, 90, 90] },
        { src: 'hamper1.glb', p: [-46, 20, -216], r: [0, 0], s: [11, 11, 11] },
        { src: 'cam.glb', p: [65, 12, -314], r: [265, 0], s: [5, 5, 5] }
    ];

    async function boot() {
        await initDB();
        const statsText = document.getElementById('loader-stats');
        const progressBar = document.getElementById('progress-bar');
        const msgText = document.getElementById('loader-msg');
        let loadedCount = 0, totalMB = 0;

        for (let item of glbItems) {
            let blob = await getCached(item.src);
            if (!blob) {
                msgText.innerText = `Fetching: ${item.src}`;
                const res = await fetch(item.src);
                blob = await res.blob();
                await saveCached(item.src, blob);
            }
            if(blob) totalMB += (blob.size / (1024 * 1024));
            loadedCount++;
            statsText.innerText = `${totalMB.toFixed(1)} MB Loaded`;
            progressBar.style.width = `${(loadedCount / glbItems.length) * 100}%`;
            if(blob) {
                const url = URL.createObjectURL(blob);
                loader.load(url, (gltf) => {
                    const model = gltf.scene;
                    model.traverse(node => {
                        if (node.isMesh && node.material) {
                            if (item.src === 'indu.glb' || item.src === 'hbday.glb') {
                                node.material.metalness = 1.0;
                                node.material.roughness = 0.05;
                                node.material.envMapIntensity = 15.0;
                                if(node.material.color) node.material.color.multiplyScalar(0.8);
                            } else {
                                node.material.metalness = 0.0;
                                node.material.roughness = 0.8;
                                node.material.envMapIntensity = 1.0;
                            }
                            node.material.needsUpdate = true;
                        }
                    });
                    model.position.set(item.p[0], item.p[1], item.p[2]);
                    model.rotation.set(THREE.MathUtils.degToRad(item.r[0]), THREE.MathUtils.degToRad(item.r[1]), 0);
                    model.scale.set(item.s[0], item.s[1], item.s[2]);
                    if (gltf.animations.length > 0) {
                        const mixer = new THREE.AnimationMixer(model);
                        gltf.animations.forEach(clip => mixer.clipAction(clip).play());
                        mixers.push(mixer);
                    }
                    scene.add(model);
                    URL.revokeObjectURL(url);
                });
            }
        }

        const staticItems = [
            {src:'Picsart_26-01-08_18-59-32-352.jpg', p:[487,-46,-177], r:[90,0], s:[368,368]}, {src:'Picsart_26-01-08_18-59-32-352.jpg', p:[487,-46,-545], r:[270,0], s:[368,368]},
            {src:'Picsart_26-01-08_18-59-32-352.jpg', p:[119,-46,-545], r:[270,180], s:[368,368]}, {src:'Picsart_26-01-08_18-59-32-352.jpg', p:[119,-46,-177], r:[90,180], s:[368,368]},
            {src:'Picsart_26-01-08_18-59-32-352.jpg', p:[-249,-46,-177], r:[90,0], s:[368,368]}, {src:'Picsart_26-01-08_18-59-32-352.jpg', p:[-249,-46,-545], r:[270,0], s:[368,368]},
            {src:'Picsart_26-01-08_18-59-32-352.jpg', p:[487,-46,189], r:[270,0], s:[368,368]}, {src:'Picsart_26-01-08_18-59-32-352.jpg', p:[487,-46,557], r:[90,0], s:[368,368]}, 
            {src:'Picsart_26-01-08_18-59-32-352.jpg', p:[119,-46,189], r:[270,180], s:[368,368]}, {src:'Picsart_26-01-08_18-59-32-352.jpg', p:[119,-46,557], r:[90,180], s:[368,368]}, 
            {src:'Picsart_26-01-08_18-59-32-352.jpg', p:[-249,-46,557], r:[270,180], s:[368,368]}, {src:'Picsart_26-01-08_18-59-32-352.jpg', p:[-249,-46,189], r:[90,180], s:[368,368]}, 
            {src:'Picsart_26-01-08_18-59-32-352.jpg', p:[-617,-46,189], r:[270,180], s:[368,368]}, {src:'Picsart_26-01-08_18-59-32-352.jpg', p:[-617,-46,557], r:[90,180], s:[368,368]}, 
            {src:'Picsart_26-01-08_18-59-32-352.jpg', p:[-617,-46,-177], r:[90,180], s:[368,368]}, {src:'Picsart_26-01-08_18-59-32-352.jpg', p:[-617,-46,-545], r:[270,180], s:[368,368]},
            { src: 'surface-with-abstract-watercolor-paint_23-2148733391 (1).jpg', p: [-599, 48, -306], r: [0, 90], s: [622, 582] },
            { src: 'images - 2026-01-30T184744.639.jpeg', p: [598, 184, -599], r: [0, 0], s: [800, 589] },
            { src: 'images - 2026-01-30T184744.639.jpeg', p: [-202, 184, -599], r: [0, 0], s: [800, 589] },
            { src: 'images - 2026-01-30T184744.639.jpeg', p: [-449, 179, -9], r: [0, 0], s: [800, 589] },
            { src: 'images - 2026-01-30T184744.639.jpeg', p: [449, 184, -9], r: [0, 0], s: [800, 589] },
            { src: 'images - 2026-01-30T184744.639.jpeg', p: [49, 184, 0], r: [0, 90], s: [18, 679] },
            { src: 'images - 2026-01-30T184744.639.jpeg', p: [2, 211, -8], r: [0, 0], s: [106, 173] },
            { src: 'images - 2026-01-30T184744.639.jpeg', p: [2, 211, 8], r: [0, 0], s: [106, 173] },
            { src: 'images - 2026-01-30T184744.639.jpeg', p: [449, 184, 9], r: [0, 0], s: [800, 589] },
            { src: 'images - 2026-01-30T184744.639.jpeg', p: [-449, 179, 9], r: [0, 0], s: [800, 589] },
            { src: 'images - 2026-01-30T184744.639.jpeg', p: [-49, 184, 0], r: [0, 90], s: [18, 679] },
            { src: 'images - 2026-01-30T184744.639.jpeg', p: [598, 184, 599], r: [0, 0], s: [800, 589] },
            { src: 'images - 2026-01-30T184744.639.jpeg', p: [-202, 184, 599], r: [0, 0], s: [800, 589] },
            { src: 'surface-with-abstract-watercolor-paint_23-2148733391 (1).jpg', p: [599, 48, -306], r: [0, 90], s: [622, 582] },
            { src: 'surface-with-abstract-watercolor-paint_23-2148733391 (1).jpg', p: [599, 48, 319], r: [0, 90], s: [622, 582] },
            { src: 'surface-with-abstract-watercolor-paint_23-2148733391 (1).jpg', p: [-599, 48, 318], r: [0, 90], s: [622, 582] },
            { src: 'images - 2026-01-30T184744.639.jpeg', p: [16, 124, 0], r: [90, 0], s: [136, 18] },
            { src: 'Picsart_26-01-08_18-59-32-352.jpg', p: [447, -43, 10], r: [0, 0], s: [800, 16] },
            { src: 'Picsart_26-01-08_18-59-32-352.jpg', p: [-448, -43, 10], r: [0, 0], s: [800, 16] },
            { src: 'Picsart_26-01-08_18-59-32-352.jpg', p: [-598, -43, 391], r: [0, 90], s: [800, 16] },
            { src: 'Picsart_26-01-08_18-59-32-352.jpg', p: [-598, -43, -398], r: [0, 90], s: [800, 16] },
            { src: 'Picsart_26-01-08_18-59-32-352.jpg', p: [-448, -43, -10], r: [0, 0], s: [800, 16] },
            { src: 'Picsart_26-01-08_18-59-32-352.jpg', p: [447, -43, -10], r: [0, 0], s: [800, 16] },
            { src: 'Picsart_26-01-08_18-59-32-352.jpg', p: [598, -43, -398], r: [0, 90], s: [800, 16] },
            { src: 'Picsart_26-01-08_18-59-32-352.jpg', p: [598, -43, 407], r: [180, 90], s: [800, 16] },
            { src: 'Picsart_26-01-08_18-59-32-352.jpg', p: [211, -43, 597], r: [180, 0], s: [800, 16] },
            { src: 'Picsart_26-01-08_18-59-32-352.jpg', p: [211, -43, -596], r: [180, 0], s: [800, 16] },
            { src: 'Picsart_26-01-08_18-59-32-352.jpg', p: [-589, -43, -596], r: [180, 0], s: [800, 16] },
            { src: 'Picsart_26-01-08_18-59-32-352.jpg', p: [-589, -43, 597], r: [180, 0], s: [800, 16] },
            { src: 'Picsart_26-01-08_18-59-32-352.jpg', p: [-48, -43, 0], r: [0, 90], s: [18, 16] },
            { src: 'Picsart_26-01-08_18-59-32-352.jpg', p: [48, -43, 0], r: [0, 90], s: [18, 16] },
            { src: 'images - 2026-01-30T183236.100.jpeg', p: [-237, 298, -398], r: [90, 0], s: [800, 800] },
            { src: 'images - 2026-01-30T183236.100.jpeg', p: [-237, 298, 366], r: [90, 0], s: [800, 800] },
            { src: 'images - 2026-01-30T183236.100.jpeg', p: [563, 298, 366], r: [90, 0], s: [800, 800] },
            { src: 'images - 2026-01-30T183236.100.jpeg', p: [563, 298, -433], r: [90, 0], s: [800, 800] }
        ];

        staticItems.forEach(d => {
            const m = new THREE.Mesh(sharedPlaneGeom, new THREE.MeshBasicMaterial({ map: getTex(d.src), side: 2, transparent: true }));
            m.position.set(d.p[0], d.p[1], d.p[2]); m.rotation.set(THREE.MathUtils.degToRad(d.r[0]), THREE.MathUtils.degToRad(d.r[1]), 0); m.scale.set(d.s[0], d.s[1], 1);
            scene.add(m);
        });

        setTimeout(() => {
            document.getElementById('loader-screen').style.opacity = '0';
            setTimeout(() => { document.getElementById('loader-screen').style.display = 'none'; animate(); }, 500);
        }, 1000);
    }

    document.getElementById('copy-btn').addEventListener('click', () => {
        if (savedModels.length === 0) { alert("No user models to copy!"); return; }
        let output = "";
        savedModels.forEach(item => {
            const p = item.mesh.position; const r = item.mesh.rotation; const s = item.mesh.scale;
            output += `{ src: '${item.name}', p: [${Math.round(p.x)}, ${Math.round(p.y)}, ${Math.round(p.z)}], r: [${Math.round(THREE.MathUtils.radToDeg(r.x))}, ${Math.round(THREE.MathUtils.radToDeg(r.y))}], s: [${Math.round(s.x)}, ${Math.round(s.y)}, ${Math.round(s.z)}] },\n`;
        });
        navigator.clipboard.writeText(output).then(() => alert("Scene info copied!"));
    });

    window.snap = (id, val) => { document.getElementById(id).value = val; document.getElementById('box-'+id).value = val; updateTransform(); };
    window.step = (id, amt) => { let el = document.getElementById(id); el.value = (parseFloat(el.value) + amt).toFixed(1); document.getElementById('box-'+id).value = el.value; updateTransform(); };

    const config = [
        { id: 'posX', label: 'Pos X', min: -1200, max: 1200 }, { id: 'posY', label: 'Pos Y', min: -150, max: 800 }, { id: 'posZ', label: 'Pos Z', min: -1200, max: 1200 }, 
        { id: 'rotY', label: 'Rot Horiz', min: 0, max: 360, snaps: [0, 90, 180, 270] }, { id: 'rotX', label: 'Rot Vert', min: 0, max: 360, snaps: [0, 90, 180, 270] }, 
        { id: 'width', label: 'Scale W', min: -800, max: 800 }, { id: 'height', label: 'Scale H', min: -800, max: 800 }
    ];

    const dynContainer = document.getElementById('dynamic-controls');
    config.forEach(c => {
        const div = document.createElement('div');
        div.innerHTML = `<div class="ctrl-row"><label>${c.label}</label><div class="val-grp"><button class="step-b" onclick="window.step('${c.id}', -5)">-</button><input type="number" id="box-${c.id}" class="num-in" value="0" step="1"><button class="step-b" onclick="window.step('${c.id}', 5)">+</button></div></div><input type="range" id="${c.id}" min="${c.min}" max="${c.max}" value="0" step="1">${c.snaps ? `<div class="snap-row">${c.snaps.map(s => `<div class="snap-dot" onclick="window.snap('${c.id}', ${s})">${s}Â°</div>`).join('')}</div>` : ''}`;
        dynContainer.appendChild(div);
        document.getElementById(c.id).oninput = () => { document.getElementById('box-'+c.id).value = document.getElementById(c.id).value; updateTransform(); };
        document.getElementById('box-'+c.id).oninput = () => { document.getElementById(c.id).value = document.getElementById('box-'+c.id).value; updateTransform(); };
    });

    document.getElementById('file-input').onchange = (e) => {
        const file = e.target.files[0]; if (!file) return;
        const url = URL.createObjectURL(file);
        const spawnPos = new THREE.Vector3(0, 0, -100).applyQuaternion(camera.quaternion).add(camera.position);
        if (file.name.match(/\.(jpg|jpeg|png|webp)$/i)) {
            texLoader.load(url, (tex) => {
                const m = new THREE.Mesh(sharedPlaneGeom, new THREE.MeshBasicMaterial({ map: tex, side: 2, transparent: true }));
                m.position.copy(spawnPos); m.scale.set(60, 60, 1); addUserModel(m, file.name, true);
            });
        } else {
            loader.load(url, (gltf) => { 
                const model = gltf.scene;
                model.traverse(node => { if(node.isMesh && node.material) { node.material.envMapIntensity = 2.5; node.material.roughness = 0.1; node.material.metalness = 0.8; }});
                model.position.copy(spawnPos); addUserModel(model, file.name, false); 
            });
        }
    };

    function addUserModel(mesh, name, isImg) {
        scene.add(mesh);
        const el = document.createElement('div'); el.className = 'model-label'; el.innerHTML = name.substring(0, 12);
        const lbl = new CSS3DObject(el); lbl.position.copy(mesh.position); cssScene.add(lbl);
        savedModels.push({ mesh, label: lbl, name, isImg });
        updateListUI(); startEditing(savedModels.length - 1);
    }

    function startEditing(i) {
        window.editingIndex = i; const m = savedModels[i].mesh;
        const sync = (id, val) => { 
            const rounded = Math.round(val);
            document.getElementById(id).value = rounded; 
            document.getElementById('box-'+id).value = rounded; 
        };
        sync('posX', m.position.x); sync('posY', m.position.y); sync('posZ', m.position.z);
        sync('width', m.scale.x); sync('height', m.scale.y);
        sync('rotX', THREE.MathUtils.radToDeg(m.rotation.x)); sync('rotY', THREE.MathUtils.radToDeg(m.rotation.y));
    }

    function updateTransform() {
        if (window.editingIndex === -1) return;
        const d = savedModels[window.editingIndex], val = (id) => parseFloat(document.getElementById(id).value);
        d.mesh.position.set(val('posX'), val('posY'), val('posZ'));
        d.mesh.rotation.set(THREE.MathUtils.degToRad(val('rotX')), THREE.MathUtils.degToRad(val('rotY')), 0);
        if(d.isImg) d.mesh.scale.set(val('width'), val('height'), 1); else d.mesh.scale.set(val('width'), val('width'), val('width'));
        d.label.position.copy(d.mesh.position); 
        d.label.position.y += (d.isImg ? Math.abs(val('height'))/2 : Math.abs(val('width'))) + 15;
    }

    window.editM = (i) => startEditing(i);
    window.delM = (i) => { 
        disposeObj(savedModels[i].mesh);
        scene.remove(savedModels[i].mesh); 
        cssScene.remove(savedModels[i].label); 
        savedModels.splice(i, 1); window.editingIndex = -1; updateListUI(); 
    };
    window.dupM = (i) => { 
        const s = savedModels[i]; 
        const nm = s.mesh.clone(); 
        if(s.isImg) nm.material = s.mesh.material.clone(); 
        addUserModel(nm, s.name + "_copy", s.isImg); 
    };

    function updateListUI() {
        const c = document.getElementById('items-container'); c.innerHTML = '';
        savedModels.forEach((m, i) => {
            const div = document.createElement('div'); div.className = 'list-item';
            div.innerHTML = `<strong>${m.name}</strong><div class="row"><button class="ui-s-btn" onclick="window.editM(${i})">EDIT</button><button class="ui-s-btn dup" onclick="window.dupM(${i})">DUP</button><button class="ui-s-btn del" onclick="window.delM(${i})">DEL</button></div>`;
            c.appendChild(div);
        });
    }

    const box = (w, h, d, x, y, z, color) => {
        const m = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), new THREE.MeshStandardMaterial({color, roughness: 0.1}));
        m.position.set(x,y,z); scene.add(m); return m;
    };
    box(W, 2, H, 0, floorY, 0, "#222"); box(W, 2, H, 0, floorY + T, 0, "#ffffff"); 
    box(W, T, 10, 0, floorY+T/2, 605, "#333"); box(W, T, 10, 0, floorY+T/2, -605, "#333"); 
    box(10, T, H, -605, floorY+T/2, 0, "#333"); box(10, T, H, 605, floorY+T/2, 0, "#333"); 
    box(550, T, 15, -325, floorY+T/2, 0, "#333"); box(550, T, 15, 325, floorY+T/2, 0, "#333"); 
    box(100, T-180, 15, 0, floorY+260, 0, "#333"); const doorMesh = box(100, 180, 8, 0, floorY + 90, 0, "#111");

    const frameEl = document.getElementById('html-frame-element');
    const cssObj = new CSS3DObject(frameEl); cssObj.position.set(-585, floorY + 150, -300); cssObj.rotation.y = Math.PI/2; cssObj.scale.set(0.15, 0.15, 0.15); cssScene.add(cssObj);
    const occMesh = new THREE.Mesh(new THREE.PlaneGeometry(1280, 720), new THREE.MeshBasicMaterial({ color: 0x000, transparent: true, opacity: 0, blending: THREE.NoBlending }));
    occMesh.position.copy(cssObj.position); occMesh.rotation.copy(cssObj.rotation); occMesh.scale.copy(cssObj.scale); scene.add(occMesh);

    let joyId = null, lookId = null, lastL = {x:0, y:0}, joySt = {x:0, y:0};
    const zMove = document.getElementById('zone-move'), zLook = document.getElementById('zone-look'), joyS = document.getElementById('joy-stick'), joyC = document.getElementById('joy-container');
    zMove.addEventListener('touchstart', e => { if(isInteracting) return; const t = e.changedTouches[0]; joyId = t.identifier; joySt = {x:t.clientX, y:t.clientY}; joyC.style.display='block'; joyC.style.left=t.clientX+'px'; joyC.style.top=t.clientY+'px'; });
    zMove.addEventListener('touchmove', e => { if(isInteracting) return; for(let t of e.changedTouches) if(t.identifier === joyId) { let dx = t.clientX-joySt.x, dy = t.clientY-joySt.y; const d = Math.min(Math.sqrt(dx*dx+dy*dy), 35); const a = Math.atan2(dy, dx); joyS.style.transform = `translate(calc(-50% + ${Math.cos(a)*d}px), calc(-50% + ${Math.sin(a)*d}px))`; move = {x: Math.cos(a)*d/35, y: Math.sin(a)*d/35}; } });
    zMove.addEventListener('touchend', () => { joyId=null; move={x:0,y:0}; joyC.style.display='none'; });
    zLook.addEventListener('touchstart', e => { if(isInteracting) return; lookId = e.changedTouches[0].identifier; lastL = {x:e.changedTouches[0].clientX, y:e.changedTouches[0].clientY}; });
    zLook.addEventListener('touchmove', e => { if(isInteracting) return; for(let t of e.changedTouches) if(t.identifier === lookId) { camera.rotation.y -= (t.clientX - lastL.x) * 0.0035; camera.rotation.x -= (t.clientY - lastL.y) * 0.0035; camera.rotation.x = Math.max(-1.4, Math.min(1.4, camera.rotation.x)); lastL = {x:t.clientX, y:t.clientY}; } });

    const iBtn = document.getElementById('interact-btn'), pBtn = document.getElementById('power-btn');
    document.getElementById('door-btn').onclick = () => isDoorOpen = !isDoorOpen;
    pBtn.onclick = () => { isPowered = !isPowered; document.getElementById('totify-iframe').src = isPowered ? "https://impraveen07.github.io/Win7/" : ""; frameEl.style.display = isPowered ? 'block' : 'none'; pBtn.innerText = isPowered ? "ðŸ”Œ POWER OFF" : "ðŸ”Œ POWER ON"; pBtn.style.background = isPowered ? "#dc3545" : "#222"; };
    iBtn.onclick = () => { isInteracting = !isInteracting; if(isInteracting) { cssRenderer.domElement.style.zIndex='999'; cssRenderer.domElement.style.pointerEvents='auto'; renderer.domElement.style.zIndex='1'; zMove.style.pointerEvents='none'; zLook.style.pointerEvents='none'; document.getElementById('touch-blocker').style.display='none'; iBtn.innerText="ðŸ”’ EXIT INTERACT"; iBtn.style.background="#dc3545"; } else { renderer.domElement.style.zIndex='2'; cssRenderer.domElement.style.zIndex='1'; cssRenderer.domElement.style.pointerEvents='none'; zMove.style.pointerEvents='auto'; zLook.style.pointerEvents='auto'; document.getElementById('touch-blocker').style.display='block'; iBtn.innerText="ðŸŽ¯ INTERACT"; iBtn.style.background="#007bff"; move={x:0,y:0}; } };

    camera.position.set(0, 50, 400);
    const fVec = new THREE.Vector3(), rVec = new THREE.Vector3();

    function animate() {
        requestAnimationFrame(animate);
        const delta = clock.getDelta();
        mixers.forEach(m => m.update(delta));
        if(!isInteracting && (move.x !== 0 || move.y !== 0)) {
            fVec.set(0,0,-1).applyQuaternion(camera.quaternion); fVec.y=0; fVec.normalize();
            rVec.set(1,0,0).applyQuaternion(camera.quaternion); rVec.y=0; rVec.normalize();
            velocity.add(fVec.multiplyScalar(-move.y *.8)).add(rVec.multiplyScalar(move.x * 1.5));
        }
        velocity.multiplyScalar(0.9); camera.position.add(velocity);
        camera.position.x = Math.max(-550, Math.min(550, camera.position.x)); camera.position.z = Math.max(-550, Math.min(550, camera.position.z));
        if(Math.abs(camera.position.z) < 25 && (!isDoorOpen || Math.abs(camera.position.x) > 45)) camera.position.z = camera.position.z > 0 ? 25 : -25;
        savedModels.forEach(m => m.label.quaternion.copy(camera.quaternion));
        document.getElementById('door-btn').style.display = Math.abs(camera.position.z) < 180 ? 'block' : 'none';
        pBtn.style.display = (camera.position.z < 0 && camera.position.distanceTo(cssObj.position) < 450) ? 'block' : 'none';
        iBtn.style.display = (isPowered && camera.position.z < 0 && camera.position.distanceTo(cssObj.position) < 350) ? 'block' : 'none';
        doorMesh.position.x += ((isDoorOpen ? -110 : 0) - doorMesh.position.x) * 0.1;
        cssRenderer.render(cssScene, camera); renderer.render(scene, camera); 
        document.getElementById('room-display').innerText = camera.position.z > 0 ? "SPAWN ROOM" : "TV ROOM";
    }
    boot();
</script>
</body>
</html>
