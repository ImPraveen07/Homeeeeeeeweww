<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sleek Gallery - Real Interact</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #f0f0f0; touch-action: none; font-family: sans-serif; user-select: none; -webkit-user-select: none; }
        
        #ui-layer { position: absolute; top: 15px; width: 100%; text-align: center; pointer-events: none; z-index: 9000; }
        #room-display { font-size: 11px; letter-spacing: 1px; color: #fff; background: rgba(0,0,0,0.7); padding: 5px 15px; border-radius: 4px; display: inline-block; text-transform: uppercase; }
        
        .action-btn {
            position: absolute; left: 50%; transform: translateX(-50%);
            padding: 14px 28px; font-size: 14px; font-weight: bold; color: #fff;
            border-radius: 30px; cursor: pointer; display: none; 
            z-index: 9500; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        #door-btn { top: 40%; background: #333; }
        #power-btn { bottom: 85px; background: #222; }
        #interact-btn { bottom: 30px; background: #007bff; }

        #zone-move { position: absolute; top: 0; left: 0; width: 45vw; height: 100vh; z-index: 8000; }
        #zone-look { position: absolute; top: 0; right: 0; width: 45vw; height: 100vh; z-index: 8000; }
        
        /* High Z-index for Look Zone even in Interact */
        #zone-look.interact-mode { z-index: 9600; width: 30vw; height: 100vh; right: 0; }

        #joy-container { position: absolute; width: 80px; height: 80px; display: none; pointer-events: none; z-index: 8100; transform: translate(-50%, -50%); }
        #joy-base { width: 100%; height: 100%; border: 2px solid rgba(0,0,0,0.2); border-radius: 50%; background: rgba(255,255,255,0.1); }
        #joy-stick { position: absolute; top: 50%; left: 50%; width: 30px; height: 30px; background: #333; border-radius: 50%; transform: translate(-50%, -50%); }
        
        #html-frame-element { width: 1000px; height: 600px; background: #000; border: 10px solid #fff; position: relative; }
        #touch-blocker { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: transparent; z-index: 10; }
        #html-frame-element.active { border-color: #007bff; box-shadow: 0 0 50px rgba(0,123,255,0.4); }
        iframe { width: 100%; height: 100%; border: none; background: #000; }
    </style>
</head>
<body>

<div id="ui-layer"><div id="room-display">SPAWN ROOM</div></div>
<button id="door-btn" class="action-btn">ðŸšª OPEN DOOR</button>
<button id="power-btn" class="action-btn">ðŸ”Œ POWER ON</button>
<button id="interact-btn" class="action-btn">ðŸŽ¯ INTERACT</button>

<div id="zone-move"></div>
<div id="zone-look"></div>
<div id="joy-container"><div id="joy-base"></div><div id="joy-stick"></div></div>

<div style="display:none;">
    <div id="html-frame-element">
        <div id="touch-blocker"></div>
        <iframe id="totify-iframe" src=""></iframe>
    </div>
</div>

<script type="importmap">
    { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/" } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { CSS3DRenderer, CSS3DObject } from 'three/addons/renderers/CSS3DRenderer.js';

    const floorY = -50, T = 200, W = 800, H = 800;
    let isDoorOpen = false, isPowered = false, isInteracting = false;
    let velocity = new THREE.Vector3(), move = {x:0, y:0};

    const scene = new THREE.Scene(); scene.background = new THREE.Color(0xeeeeee);
    const cssScene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 1, 1500);
    camera.rotation.order = 'YXZ';

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const cssRenderer = new CSS3DRenderer();
    cssRenderer.setSize(window.innerWidth, window.innerHeight);
    cssRenderer.domElement.style.position = 'absolute';
    cssRenderer.domElement.style.top = '0';
    cssRenderer.domElement.style.pointerEvents = 'none';
    cssRenderer.domElement.style.zIndex = '500';
    document.body.appendChild(cssRenderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 1.0));

    function box(w, h, d, x, y, z, color) {
        const m = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), new THREE.MeshStandardMaterial({color}));
        m.position.set(x, y, z); scene.add(m); return m;
    }

    // SLIM WALL DESIGN
    box(W, 2, H, 0, floorY, 0, 0xcccccc); 
    box(W, 2, H, 0, floorY + T, 0, 0xffffff); 
    box(W, T, 10, 0, floorY + T/2, 405, 0xdddddd); 
    box(W, T, 10, 0, floorY + T/2, -405, 0xdddddd); 
    box(10, T, H, -405, floorY + T/2, 0, 0xffffff); 
    box(10, T, H, 405, floorY + T/2, 0, 0xffffff); 
    box(365, T, 15, -217, floorY + T/2, 0, 0xffffff);
    box(365, T, 15, 217, floorY + T/2, 0, 0xffffff);
    box(70, T - 120, 15, 0, floorY + 160, 0, 0xffffff);
    const doorMesh = box(70, 120, 8, 0, floorY + 60, 0, 0x222222); 

    const frameEl = document.getElementById('html-frame-element');
    const tBlocker = document.getElementById('touch-blocker');
    const iframe = document.getElementById('totify-iframe');
    const cssObj = new CSS3DObject(frameEl);
    cssObj.position.set(-398, floorY + 100, -200); 
    cssObj.rotation.y = Math.PI / 2;
    cssObj.scale.set(0.12, 0.12, 0.12);
    cssScene.add(cssObj);

    let joyId = null, lookId = null, lastL = {x:0, y:0}, joySt = {x:0, y:0};
    const zMove = document.getElementById('zone-move'), zLook = document.getElementById('zone-look');
    const joyS = document.getElementById('joy-stick'), joyC = document.getElementById('joy-container');

    zMove.addEventListener('touchstart', e => {
        if(isInteracting) return;
        const t = e.changedTouches[0]; joyId = t.identifier; joySt = {x:t.clientX, y:t.clientY};
        joyC.style.display='block'; joyC.style.left=t.clientX+'px'; joyC.style.top=t.clientY+'px';
    });
    zMove.addEventListener('touchmove', e => {
        if(isInteracting) return;
        for(let t of e.changedTouches) if(t.identifier === joyId) {
            let dx = t.clientX-joySt.x, dy = t.clientY-joySt.y;
            const d = Math.min(Math.sqrt(dx*dx+dy*dy), 35); const a = Math.atan2(dy, dx);
            joyS.style.transform = `translate(calc(-50% + ${Math.cos(a)*d}px), calc(-50% + ${Math.sin(a)*d}px))`;
            move = {x: Math.cos(a)*d/35, y: Math.sin(a)*d/35};
        }
    });
    zMove.addEventListener('touchend', () => { joyId=null; move={x:0,y:0}; joyC.style.display='none'; });

    zLook.addEventListener('touchstart', e => {
        // Look always works unless touching the middle of the web in interact mode
        lookId = e.changedTouches[0].identifier; lastL = {x:e.changedTouches[0].clientX, y:e.changedTouches[0].clientY};
    });
    zLook.addEventListener('touchmove', e => {
        for(let t of e.changedTouches) if(t.identifier === lookId) {
            camera.rotation.y -= (t.clientX - lastL.x) * 0.005;
            camera.rotation.x -= (t.clientY - lastL.y) * 0.005;
            camera.rotation.x = Math.max(-1.4, Math.min(1.4, camera.rotation.x));
            lastL = {x:t.clientX, y:t.clientY};
        }
    });

    const dBtn = document.getElementById('door-btn'), pBtn = document.getElementById('power-btn'), iBtn = document.getElementById('interact-btn');
    dBtn.onclick = () => isDoorOpen = !isDoorOpen;
    pBtn.onclick = () => {
        isPowered = !isPowered;
        iframe.src = isPowered ? "https://totify.netlify.app/" : "";
        pBtn.innerText = isPowered ? "ðŸ”Œ POWER OFF" : "ðŸ”Œ POWER ON";
        if(!isPowered) toggleInteract(false);
    };
    iBtn.onclick = () => toggleInteract(!isInteracting);

    function toggleInteract(state) {
        isInteracting = state;
        if(isInteracting) {
            move = {x:0, y:0}; joyC.style.display='none';
            zMove.style.display = 'none'; 
            zLook.classList.add('interact-mode'); // Shift look zone to side
            tBlocker.style.display = 'none';
            cssRenderer.domElement.style.pointerEvents = 'auto';
            frameEl.classList.add('active');
            iBtn.innerText = "ðŸ”’ EXIT";
        } else {
            zMove.style.display = 'block';
            zLook.classList.remove('interact-mode');
            tBlocker.style.display = 'block';
            cssRenderer.domElement.style.pointerEvents = 'none';
            frameEl.classList.remove('active');
            iBtn.innerText = "ðŸŽ¯ INTERACT";
        }
    }

    camera.position.set(0, 50, 200);

    function animate() {
        requestAnimationFrame(animate);
        
        // Physics logic
        if(!isInteracting) {
            if(move.x || move.y) {
                const f = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion); f.y=0; f.normalize();
                const r = new THREE.Vector3(1,0,0).applyQuaternion(camera.quaternion); r.y=0; r.normalize();
                velocity.add(f.multiplyScalar(-move.y * 1.5)).add(r.multiplyScalar(move.x * 1.5));
            }
        }
        
        velocity.multiplyScalar(0.9); camera.position.add(velocity);

        // Solid Collisions
        camera.position.x = Math.max(-360, Math.min(360, camera.position.x));
        camera.position.z = Math.max(-360, Math.min(360, camera.position.z));
        if(Math.abs(camera.position.z) < 20 && (!isDoorOpen || Math.abs(camera.position.x) > 35)) {
            camera.position.z = camera.position.z > 0 ? 20 : -20;
        }

        const inMusicRoom = camera.position.z < 0;
        const dist = camera.position.distanceTo(cssObj.position);

        if(!inMusicRoom && isPowered) {
            isPowered = false; iframe.src = ""; pBtn.innerText = "ðŸ”Œ POWER ON";
            toggleInteract(false);
        }

        dBtn.style.display = Math.abs(camera.position.z) < 130 ? 'block' : 'none';
        pBtn.style.display = (inMusicRoom && dist < 300) ? 'block' : 'none';
        iBtn.style.display = (isPowered && dist < 220) ? 'block' : 'none';
        document.getElementById('room-display').innerText = inMusicRoom ? "MUSIC GALLERY" : "SPAWN ROOM";

        doorMesh.position.x += ((isDoorOpen ? -75 : 0) - doorMesh.position.x) * 0.1;
        renderer.render(scene, camera);
        if(inMusicRoom) cssRenderer.render(cssScene, camera);
    }
    animate();
</script>
</body>
</html>

